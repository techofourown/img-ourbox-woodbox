#!/usr/bin/env bash
set -euo pipefail

# ourbox-status — persistent boot-time status reporter
#
# Polls system state every 10s during boot, writes to /dev/console
# and /run/ourbox/status (read by MOTD and `woodbox status`).
# Switches to 60s interval once all services are ready.
# Silenced by `woodbox quiet` (creates /var/lib/ourbox/state/quiet).

QUIET_MARKER="/var/lib/ourbox/state/quiet"
STATUS_FILE="/run/ourbox/status"
BOOT_INTERVAL=10
READY_INTERVAL=60
HOSTNAME="$(hostname)"

mkdir -p /run/ourbox

# Always start loud on boot.
rm -f "$QUIET_MARKER"

check_data_mount() {
  mountpoint -q /var/lib/ourbox 2>/dev/null
}

check_network() {
  ip -o -4 addr show scope global up 2>/dev/null \
    | awk '{split($4,a,"/"); print a[1]}' | head -n1
}

check_k3s_api() {
  /usr/local/bin/k3s kubectl get nodes --no-headers 2>/dev/null | grep -q .
}

check_traefik() {
  local rc
  rc=$(curl -s -o /dev/null -w '%{http_code}' -m 2 http://127.0.0.1/ 2>/dev/null) || true
  [[ -n "$rc" && "$rc" != "000" ]]
}

check_mdns() {
  systemctl is-active --quiet ourbox-mdns-aliases 2>/dev/null
}

check_bootstrap_done() {
  [[ -f /var/lib/ourbox/state/bootstrap.done ]]
}

check_pods_ready() {
  local total ready
  total="$(/usr/local/bin/k3s kubectl get pods -n ourbox-system --no-headers 2>/dev/null | wc -l)"
  ready="$(/usr/local/bin/k3s kubectl get pods -n ourbox-system --no-headers 2>/dev/null | grep -c 'Running' || true)"
  if (( total > 0 && total == ready )); then
    return 0
  fi
  echo "${ready}/${total}"
  return 1
}

format_status() {
  local ip="$1" data_ok="$2" net_ok="$3" k3s_ok="$4" traefik_ok="$5" mdns_ok="$6" bootstrap_ok="$7" pods_info="$8" all_ready="$9"

  local mark_ok="OK" mark_wait=".." mark_no="  "
  local out=""

  out+="--- OurBox Woodbox Status ---"$'\n'

  if [[ "$data_ok" == "1" ]]; then
    out+="  [${mark_ok}] DATA disk mounted"$'\n'
  else
    out+="  [${mark_wait}] DATA disk: waiting for mount"$'\n'
  fi

  if [[ "$net_ok" == "1" ]]; then
    out+="  [${mark_ok}] Network: ${ip}"$'\n'
  else
    out+="  [${mark_wait}] Network: waiting for DHCP"$'\n'
  fi

  if [[ "$k3s_ok" == "1" ]]; then
    out+="  [${mark_ok}] k3s API: running"$'\n'
  elif [[ "$net_ok" == "1" ]]; then
    out+="  [${mark_wait}] k3s API: starting"$'\n'
  else
    out+="  [${mark_no}] k3s API: waiting for network"$'\n'
  fi

  if [[ "$traefik_ok" == "1" ]]; then
    out+="  [${mark_ok}] Traefik: listening on port 80"$'\n'
  elif [[ "$k3s_ok" == "1" ]]; then
    out+="  [${mark_wait}] Traefik: deploying"$'\n'
  else
    out+="  [${mark_no}] Traefik: waiting for k3s"$'\n'
  fi

  if [[ "$k3s_ok" == "1" ]]; then
    if [[ "$pods_info" == "ready" ]]; then
      out+="  [${mark_ok}] Apps: all running"$'\n'
    else
      out+="  [${mark_wait}] Apps: ${pods_info} pods running"$'\n'
    fi
  else
    out+="  [${mark_no}] Apps: waiting for k3s"$'\n'
  fi

  if [[ "$mdns_ok" == "1" ]]; then
    out+="  [${mark_ok}] mDNS: aliases published"$'\n'
  elif [[ "$net_ok" == "1" ]]; then
    out+="  [${mark_wait}] mDNS: starting"$'\n'
  else
    out+="  [${mark_no}] mDNS: waiting for network"$'\n'
  fi

  if [[ "$bootstrap_ok" != "1" ]]; then
    out+=$'\n'
    out+="  First boot in progress — this takes several minutes."$'\n'
    out+="  Do not power off the device."$'\n'
  fi

  if [[ "$all_ready" == "1" ]]; then
    out+=$'\n'
    out+="  ========================================"$'\n'
    out+="    OurBox Woodbox is READY"$'\n\n'
    out+="    http://${HOSTNAME}.local"$'\n'
    out+="    http://files.${HOSTNAME}.local"$'\n'
    out+="    http://notes.${HOSTNAME}.local"$'\n'
    out+="    http://todo.${HOSTNAME}.local"$'\n\n'
    out+="    Commands:"$'\n'
    out+="      woodbox status  — show this status"$'\n'
    out+="      woodbox quiet   — silence console output"$'\n'
    out+="      woodbox loud    — resume console output"$'\n'
    out+="  ========================================"$'\n'
  fi

  echo "$out"
}

was_ready=false

while true; do
  data_ok=0; check_data_mount && data_ok=1
  net_ok=0; ip=""; ip="$(check_network)"; [[ -n "$ip" ]] && net_ok=1
  k3s_ok=0; check_k3s_api && k3s_ok=1
  traefik_ok=0; check_traefik && traefik_ok=1
  mdns_ok=0; check_mdns && mdns_ok=1
  bootstrap_ok=0; check_bootstrap_done && bootstrap_ok=1

  pods_info="0/0"
  if [[ "$k3s_ok" == "1" ]]; then
    pods_info="$(check_pods_ready)" && pods_info="ready"
  fi

  all_ready=0
  if [[ "$data_ok$net_ok$k3s_ok$traefik_ok$mdns_ok" == "11111" && "$pods_info" == "ready" ]]; then
    all_ready=1
  fi

  status="$(format_status "$ip" "$data_ok" "$net_ok" "$k3s_ok" "$traefik_ok" "$mdns_ok" "$bootstrap_ok" "$pods_info" "$all_ready")"

  echo "$status" > "${STATUS_FILE}"

  if [[ ! -f "$QUIET_MARKER" ]]; then
    echo "" > /dev/console 2>/dev/null || true
    echo "$status" > /dev/console 2>/dev/null || true
  fi

  if [[ "$all_ready" == "1" ]]; then
    [[ "$was_ready" == "false" ]] && was_ready=true
    sleep "$READY_INTERVAL"
  else
    sleep "$BOOT_INTERVAL"
  fi
done
