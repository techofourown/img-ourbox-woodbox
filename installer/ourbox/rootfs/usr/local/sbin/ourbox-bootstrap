#!/usr/bin/env bash
set -euo pipefail

log(){ echo "[$(date -Is)] $*"; }

STATE_DIR="/var/lib/ourbox/state"
MARKER="${STATE_DIR}/bootstrap.done"
KUBECONFIG_PATH="/etc/rancher/k3s/k3s.yaml"
HOSTNAME="$(hostname)"

# idempotent
if [[ -f "$MARKER" ]]; then
  exit 0
fi

# hard requirement: don't bootstrap platform onto OS disk
if ! mountpoint -q /var/lib/ourbox; then
  echo "ERROR: /var/lib/ourbox is not mounted. Refusing to bootstrap." >&2
  exit 1
fi

mkdir -p \
  "$STATE_DIR" \
  "/var/lib/ourbox/device" \
  "/var/lib/ourbox/secrets" \
  "/var/lib/ourbox/k3s/agent/images" \
  "/var/lib/ourbox/share" \
  "/var/lib/ourbox/flatnotes" \
  "/var/lib/ourbox/todo-bloom" \
  "/var/lib/ourbox/landing"

# device_id (stable)
if [[ ! -f /var/lib/ourbox/device/device_id ]]; then
  cat /proc/sys/kernel/random/uuid > /var/lib/ourbox/device/device_id
fi
DEVICE_ID="$(cat /var/lib/ourbox/device/device_id)"

# k3s token (stable)
if [[ ! -f /var/lib/ourbox/secrets/k3s_token ]]; then
  head -c 32 /dev/urandom | od -An -tx1 | tr -d ' \n' > /var/lib/ourbox/secrets/k3s_token
  chmod 0600 /var/lib/ourbox/secrets/k3s_token
fi
TOKEN="$(cat /var/lib/ourbox/secrets/k3s_token)"

log "Copying static files to DATA disk"
cp -f /opt/ourbox/airgap/platform/todo-bloom/* /var/lib/ourbox/todo-bloom/ 2>/dev/null || true
cp -f /opt/ourbox/airgap/platform/landing/* /var/lib/ourbox/landing/ 2>/dev/null || true

# Write k3s config (data-dir on DATA disk)
# CRITICAL: keep servicelb disabled — we use Traefik hostPort.
# DO NOT set node-ip or bind-address — let k3s auto-detect from the default route.
mkdir -p /etc/rancher/k3s
cat > /etc/rancher/k3s/config.yaml <<EOF_CONFIG
token: "${TOKEN}"
data-dir: /var/lib/ourbox/k3s
write-kubeconfig-mode: "0644"
tls-san:
  - "127.0.0.1"
  - "${HOSTNAME}"
  - "${HOSTNAME}.local"
disable:
  - servicelb
EOF_CONFIG

# Configure Traefik to use hostPort 80/443 directly.
AUTODEPLOY_DIR="/var/lib/ourbox/k3s/server/manifests"
mkdir -p "${AUTODEPLOY_DIR}"
cat > "${AUTODEPLOY_DIR}/traefik-config.yaml" <<'EOF_TRAEFIK'
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    ports:
      web:
        hostPort: 80
      websecure:
        hostPort: 443
EOF_TRAEFIK

log "Hydrating airgap image tars into /var/lib/ourbox/k3s/agent/images"
shopt -s nullglob
for tar in /opt/ourbox/airgap/k3s/*.tar /opt/ourbox/airgap/platform/images/*.tar; do
  base="$(basename "${tar}")"
  dst="/var/lib/ourbox/k3s/agent/images/${base}"
  if [[ -f "${dst}" ]]; then
    continue
  fi
  cp -f "${tar}" "${dst}"
done
shopt -u nullglob

log "Hydrated tar files:"
ls -1 /var/lib/ourbox/k3s/agent/images/*.tar 2>/dev/null || true

# Fail fast if memory controller isn't available
if [[ -f /sys/fs/cgroup/cgroup.controllers ]] && ! grep -qw memory /sys/fs/cgroup/cgroup.controllers; then
  echo "ERROR: cgroup v2 memory controller not enabled. k3s will fail." >&2
  echo "Expected: 'memory' in /sys/fs/cgroup/cgroup.controllers" >&2
  exit 1
fi

# Start k3s (enabled only after hydration prep)
systemctl enable k3s.service
systemctl start k3s.service

# Wait for kubeconfig + API
log "Waiting for k3s kubeconfig + API..."
for i in $(seq 1 600); do
  if [[ -f "${KUBECONFIG_PATH}" ]]; then
    if /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" get nodes >/dev/null 2>&1; then
      log "k3s API is up (after ${i}s)"
      break
    fi
  fi

  if systemctl is-failed --quiet k3s.service; then
    echo "ERROR: k3s.service is failed. Recent logs:" >&2
    journalctl -u k3s --no-pager -n 120 >&2 || true
    exit 1
  fi

  if (( i % 10 == 0 )); then
    log "still waiting... (${i}/600)"
  fi
  sleep 1
done

if ! /usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" get nodes >/dev/null 2>&1; then
  echo "ERROR: k3s API never became ready. Recent logs:" >&2
  journalctl -u k3s --no-pager -n 200 >&2 || true
  exit 1
fi

# Render ingress with runtime hostname
TMP_MANIFEST_DIR="/run/ourbox-bootstrap/manifests"
mkdir -p "${TMP_MANIFEST_DIR}"
cp -a /opt/ourbox/airgap/platform/manifests/. "${TMP_MANIFEST_DIR}/"

cat > "${TMP_MANIFEST_DIR}/50-ingress.yaml" <<EOF_INGRESS
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ourbox-apps
  namespace: ourbox-system
spec:
  rules:
    - host: ${HOSTNAME}.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: landing
                port:
                  number: 80
    - host: files.${HOSTNAME}.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dufs
                port:
                  number: 5000
    - host: notes.${HOSTNAME}.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: flatnotes
                port:
                  number: 8080
    - host: todo.${HOSTNAME}.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: todo-bloom
                port:
                  number: 80
  defaultBackend:
    service:
      name: landing
      port:
        number: 80
EOF_INGRESS

log "Applying platform manifests"
/usr/local/bin/k3s kubectl --kubeconfig "${KUBECONFIG_PATH}" apply -f "${TMP_MANIFEST_DIR}"

date -Is > "$MARKER"
echo "OurBox bootstrap complete. device_id=${DEVICE_ID}"
